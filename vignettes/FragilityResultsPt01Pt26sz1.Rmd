---
title: "Fragility reproducibility results for patient 01 and 26 seizure 1"
author: "Anne-Cecile Lesage, PhD, Oliver Zhou, BA, Jiefei Wang, PhD"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fragility reproducibility results for patient 01 and 26 seizure 1}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(EZFragility)
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.align = "center",
    fig.width = 10,
    fig.height = 8
)
```

This vignette shows how to reproduce results from the companion software paper of the <a href="https://cran.r-project.org/web/packages/EZFragility/index.html" style="color:blue; text-decoration:none;"> EZFragility CRAN R package</a> for the first seizure of patients 01 and 26. This allows the user to check how well the EZFragility package reproduces results from the <a href="https://www.nature.com/articles/s41593-021-00901-w" style="color:blue; text-decoration:none;"> original neural fragility paper </a>(see Figure 4 and extended seizure 4).


## Step 1.  Visualize content of data package

To allow fast and easy exploration of fragility results,  we preprocessed the multipatient data from 
the <a href="https://openneuro.org/datasets/ds003029/versions/1.0.0/metadata" style="color:blue; text-decoration:none;"> OpenNeuro Fragility Data Set</a> with <a href="https://rave.wiki/" style="color:blue; text-decoration:none;"> RAVE 2.0 </a>. Main steps included Notch filtering to remove power line interference, re-referencing, and epoching based on seizure onset time to isolate relevant segments of [-30:30s]. The data names list (dl) displays the patient identifier and the seizure number of each Epoch object file ( <a href="https://github.com/Jiefei-Wang/Epoch" style="color:blue; text-decoration:none;"> Epoch package</a>).
```{r}
dl <- EpochDownloader()
names(dl)
```


## -----------------------
## Patient 01
## -----------------------

## Step 2.  Visualize voltage plot
The preprocessed voltage data from seizure 1 of patient PT01 can be loaded in the window [-30:30]s as an Epoch package object and cropped down to the [-10:10]s time window around seizure onset with the following code.
```{r}
pt01sz1 <- dl$Retrostudy_subpt01_1
pt01sz1Clipped <- crop(pt01sz1, start=-10, end=10)
pt01sz1Clipped 
```
Use tblData, rowData, colData, metaData to extract data as directed in <a href="https://github.com/Jiefei-Wang/Epoch" style="color:blue; text-decoration:none;"> Epoch package</a>. sozIndex is the index of the electrodes which are labeled as in the SOZ in the original paper. 

The following code reproduces the voltage plot for the subset of electrodes displayed in the original Figure 4. The SOZ electrode names are highlighted in red.
```{r}
sozIndex <- which(rowData(pt01sz1Clipped)$soz==TRUE)
display <- c(sozIndex, 75:78) # set which electrodes to display
sz_onset <- 0
vplotpt01sz1 <- visuIEEGData(epoch = pt01sz1Clipped[display, ]) # create plot for display subset of electrodes

elecColor <- rep("black", length(display))
elecColor[1:length(sozIndex)] <- 'red' # make soz electrodes red

elecColor <- rev(elecColor) # match the electrode order in the plot

# add sz onset dashed line
vplotpt01sz1 <- vplotpt01sz1 + ggplot2::geom_vline(xintercept = sz_onset, color = "black", linetype = "dashed", linewidth = 1)

# set electrode y axis label colors
vplotpt01sz1 <- vplotpt01sz1 + ggplot2::theme(
  
  axis.text.y = ggtext::element_markdown(colour = elecColor)
  
)

vplotpt01sz1
```

## Step 3.  Compute and plot the fragility heatmap

The following code computes the fragility matrix using all electrodes and stores the results in the Fragility class object pt01sz1Frag.
```{r}
library(doSNOW)

# for parallel computing
cl <- makeCluster(4, type = "SOCK")
registerDoSNOW(cl)

# compute fragility
windowNum <- 250
step <- 125
pt01sz1Frag <- calcAdjFrag(epoch = pt01sz1Clipped, window = windowNum, step = step, parallel = TRUE, nSearch = 100L, progress = TRUE)

# Stop the parallel backend
stopCluster(cl)
```

The following code uses the Fragility class object to plot the fragility heatmap with the same display options as the previous voltage plot. Looking at both plots allows the user to check the correlation between soz patterns on electrode voltage and high fragility. 

PT01 was a surgical success, with the high-fragility electrodes identified by the algorithm matching those identified by clinical epileptologists.
```{r}
elecNames <- pt01sz1Frag$electrodes
startTimes <- pt01sz1Frag$startTimes

indexsz <- which(abs(startTimes)<=0.01) # identify sz onset time index

# display <- c(sozIndex, 75:78)
fplotpt01sz1 <- plotFragHeatmap(frag = pt01sz1Frag[display], ranked = FALSE)

# add sz onset dashed line
fplotpt01sz1 <- fplotpt01sz1 + ggplot2::geom_vline(xintercept = indexsz, color = "black", linetype = "dashed", linewidth = 1)

# set electrode y axis label colors
fplotpt01sz1 <- fplotpt01sz1 + ggplot2::theme(
  
  axis.text.y = ggtext::element_markdown(colour = elecColor)
  
)
fplotpt01sz1
```

Setting the "ranked" variable to TRUE in the plotFragHeatmap creates more contrast by ranking the fragility values at each time point and renders the heatmap closer to original figure 4.

```{r}
fplotpt01sz1 <- plotFragHeatmap(frag = pt01sz1Frag[display], groupIndex = match(sozIndex, display), ranked = TRUE)
fplotpt01sz1 <- fplotpt01sz1 + ggplot2::geom_vline(xintercept = indexsz, color = "black", linetype = "dashed", linewidth = 1)
fplotpt01sz1 <- fplotpt01sz1 + ggplot2::theme(
  
  axis.text.y = ggtext::element_markdown(colour = elecColor)
  
)
fplotpt01sz1
```

## Step 4.  Compute mean and standard deviation statistics for SOZ and non SOZ electrode group


The following code allows the user to reproduce the mean and standard deviation visualization statistics of two electrode groups (soz labeled electrodes and non soz labeled electrodes) as in extended figure 4 from the original paper. This plot shows that the fragility biomarker statistics are significantly higher in the soz labeled group (especially after seizure onset), correlating with the ground truth success outcome for this patient. 

```{r}
fdistribpt01sz1 <- plotFragDistribution(frag = pt01sz1Frag, groupIndex = sozIndex, bandType="SD", rollingWindow = 1, ranked = FALSE) ## p 1481 Extended Fig.4
fdistribpt01sz1 <- fdistribpt01sz1 + ggplot2::geom_vline(xintercept = sz_onset, color = "black", linetype = "dashed", linewidth = 1)
fdistribpt01sz1
```

## -----------------------
## Patient 26
## -----------------------

## Step 2.  Visualize voltage plot 

The preprocessed voltage data from seizure 1 of patient PT26 can be loaded in the window [-30:30]s as an Epoch package object and cropped down to the [-10:10]s time window around seizure onset with the following code.
```{r}
pt26sz1 <- dl$Retrostudy_subjh103_1
pt26sz1Clipped <- crop(pt26sz1, start=-10, end=10)
pt26sz1Clipped 
```
The same visualization process demonstrated above is repeated here for patient 26 in the original Figure 4.
```{r}
sozIndex <- which(rowData(pt26sz1)$soz==TRUE)
sozIndex <- sozIndex[-c(17,18,19,20)]

display <- c(c(1:2),sozIndex[1:16], c(53:56), sozIndex[17:18]) # set which electrodes to display

sz_onset <- 0
vplotpt26sz1 <- visuIEEGData(epoch = pt26sz1Clipped[display, ]) # create plot for display subset of electrodes

elecColor <- rep("black", length(display))
elecColor[match(sozIndex, display)] <- 'red' # make soz electrodes red

elecColor <- rev(elecColor) # match the electrode order in the plot

# add sz onset dashed line
vplotpt26sz1 <- vplotpt26sz1 + ggplot2::geom_vline(xintercept = sz_onset, color = "black", linetype = "dashed", linewidth = 1)

# set electrode y axis label colors
vplotpt26sz1 <- vplotpt26sz1 + ggplot2::theme(
  
  axis.text.y = ggtext::element_markdown(colour = elecColor)
  
)
vplotpt26sz1
```

## Step 3.  Compute and plot the fragility heatmap
The following code computes the fragility matrix on all electrodes and store the results in the Fragility class object pt26sz1Frag
```{r}
library(doSNOW)

# for parallel computing
cl <- makeCluster(4, type = "SOCK")
registerDoSNOW(cl)

# compute fragility
windowNum <- 250
step <- 125
pt26sz1Frag <- calcAdjFrag(epoch = pt26sz1Clipped, window = windowNum, step = step, parallel = TRUE, nSearch = 100L, progress = TRUE)

# Stop the parallel backend
stopCluster(cl)
```

The following code plots the fragility heatmap with the same display options as the previous voltage plot. PT26 was a surgical failure, and the high-fragility electrodes were not consistent with clinical EEG interpretation
```{r}
elecNames  <- pt26sz1Frag$electrodes
startTimes <- pt26sz1Frag$startTimes

indexsz <- which(abs(startTimes)<=0.01) # identify sz onset time index

#display <- display <- c(c(1:2),sozIndex[1:16], c(53:56), sozIndex[17:18])
fplotpt26sz1 <- plotFragHeatmap(frag = pt26sz1Frag[display], ranked = FALSE)

# add sz onset dashed line
fplotpt26sz1 <- fplotpt26sz1 + ggplot2::geom_vline(xintercept = indexsz, color = "black", linetype = "dashed", linewidth = 1)

# set electrode y axis label colors
fplotpt26sz1 <- fplotpt26sz1 + ggplot2::theme(
  
  axis.text.y = ggtext::element_markdown(colour = elecColor)
  
)
fplotpt26sz1
```

## Step 4.  Compute mean and standard deviation statistics for SOZ and non SOZ electrode group to visualy assess seizure outcome prediction

The following code allows to reproduce the mean and standard visualization statistics of two electrode groups (soz labeled electrodes and non soz labeled electrodes)
as in extended figure 4 from the original paper. This plot shows that the fragility biomarker statistics are not significantly higher in the soz labeled group correlated with the ground truth failure outcome for this patient. 

```{r}
fdistribpt26sz1 <- plotFragDistribution(frag = pt26sz1Frag, groupIndex = sozIndex, bandType = "SD", rollingWindow = 1, ranked = FALSE) ## p 1481 Extended Fig.4
fdistribpt26sz1 <- fdistribpt26sz1 + ggplot2::geom_vline(xintercept = sz_onset, color = "black", linetype = "dashed", linewidth = 1)
fdistribpt26sz1
```